{
  "rules": {
    ".read": false,
    ".write": false,

    "users": {
      "$uid": {
        ".read": "auth != null && (auth.uid == $uid || (root.child('users').child(auth.uid).child('familyGroupId').val() != null && root.child('users').child(auth.uid).child('familyGroupId').val() == root.child('users').child($uid).child('familyGroupId').val()))",
        ".write": "auth != null && auth.uid == $uid",

        "claimsUpdatedAt": {
          ".write": false
        },

        "usageCounters": {
          ".read": "auth != null && auth.uid == $uid",
          ".write": "auth != null && auth.uid == $uid && (
            !newData.exists() ||
            (newData.child('listsCreated').val() >= data.child('listsCreated').val() &&
             newData.child('ocrProcessed').val() >= data.child('ocrProcessed').val() &&
             newData.child('urgentItemsCreated').val() >= data.child('urgentItemsCreated').val())
          )",
          ".validate": "newData.hasChildren(['listsCreated', 'ocrProcessed', 'urgentItemsCreated', 'lastResetDate'])"
        }
      }
    },

    "familyGroups": {
      "$groupId": {
        ".read": "auth != null && data.child('memberIds').child(auth.uid).exists()",
        ".write": "auth != null && (data.child('memberIds').child(auth.uid).exists() || !data.exists())",

        "memberIds": {
          "$userId": {
            ".write": "auth != null && auth.uid == $userId"
          }
        },

        "subscriptionTier": {
          ".write": "auth != null && auth.token.admin === true"
        },

        "lists": {
          "$listId": {
            ".read": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".write": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".validate": "newData.hasChildren(['name', 'createdBy', 'createdAt', 'familyGroupId'])"
          }
        },

        "items": {
          "$itemId": {
            ".read": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".write": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".validate": "newData.hasChildren(['name', 'listId', 'createdBy', 'checked'])"
          }
        },

        "urgentItems": {
          "$itemId": {
            ".read": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".write": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".validate": "newData.hasChildren(['name', 'createdBy', 'createdAt', 'familyGroupId'])"
          }
        },

        "priceHistory": {
          "$recordId": {
            ".read": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".write": "auth != null && root.child('familyGroups').child($groupId).child('memberIds').hasChild(auth.uid)",
            ".validate": "newData.hasChildren(['id', 'itemName', 'price', 'recordedAt', 'familyGroupId']) && newData.child('price').isNumber() && newData.child('recordedAt').isNumber() && newData.child('itemName').isString() && newData.child('familyGroupId').isString()"
          }
        }
      }
    },

    "invitations": {
      ".read": "auth != null",
      ".indexOn": ["groupId"],
      "$code": {
        ".write": "auth != null && (!data.exists() || root.child('familyGroups').child(data.child('groupId').val()).child('memberIds').hasChild(auth.uid))",
        ".validate": "newData.hasChildren(['groupId', 'createdAt']) && newData.child('groupId').isString()"
      }
    },

    "urgentItems": {
      "$familyGroupId": {
        ".read": "auth != null && root.child('familyGroups').child($familyGroupId).child('memberIds').hasChild(auth.uid)",
        ".write": "auth != null && root.child('familyGroups').child($familyGroupId).child('memberIds').hasChild(auth.uid)",
        "$itemId": {
          ".validate": "newData.hasChildren(['name', 'createdBy', 'createdAt', 'familyGroupId'])"
        }
      }
    }
  }
}
